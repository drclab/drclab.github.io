---
title: "linear_mvn_approx.stan Walkthrough"
draft: true
---

The notes below walk through `stan/linear_mvn_approx.stan` line by line.

- Line 1 (`functions {`): Begins the Stan `functions` block where user-defined helper routines live.
- Line 2 (`  // numerically robust covariance estimate; ym is expected to be the`): Comment describing the robustness goal for the covariance helper.
- Line 3 (`  // column wise mean`): Completes the comment, clarifying that `ym` represents column means.
- Line 4 (`  matrix robust_cov(matrix y, row_vector ym) {`): Declares `robust_cov`, returning a covariance matrix given data `y` and mean `ym`.
- Line 5 (`    matrix[cols(y),cols(y)] cov;`): Allocates a square matrix sized by the number of columns in `y` to hold the covariance estimate.
- Line 6 (``): Blank line for readability.
- Line 7 (`    //cov = yc' * yc /(rows(y) - 1);`): Comment showing an alternative covariance computation that is not used.
- Line 8 (`    cov = crossprod(y - rep_matrix(ym, rows(y))) / (rows(y) - 1.0);`): Computes the centered crossproduct divided by degrees of freedom to estimate covariance.
- Line 9 (``): Blank line for readability.
- Line 10 (`    return(0.5 * (cov + cov'));`): Symmetrises the covariance matrix to alleviate numerical asymmetry.
- Line 11 (`  }`): Closes the `robust_cov` function.
- Line 12 (``): Blank line separating functions.
- Line 13 (`  real mvn_approx_lpdf(vector y_prime_bar, vector x_prime,`): Starts definition of `mvn_approx_lpdf`, approximating a marginal log-density.
- Line 14 (`                       int J_prime,`): Continues argument list with number of subjects in the second dataset.
- Line 15 (`                       vector delta,`): Adds treatment-effect shift parameters `delta`.
- Line 16 (`                       vector mu_a, real beta,`): Includes baseline mean vector and quadratic coefficient `beta`.
- Line 17 (`                       vector sigma_a, real sigma_y,`): Includes standard deviations for random effects and residual noise.
- Line 18 (`                       matrix xi  // N(0,1) as K x J_tilde`): Accepts standard-normal draws for integration, noting their shape in a comment.
- Line 19 (`                       ) {`): Closes the argument list and opens the function body.
- Line 20 (`    int J_tilde = cols(xi);`): Defines `J_tilde` as the number of simulated individuals.
- Line 21 (`    int K       = rows(delta);`): Stores the number of random-effect components.
- Line 22 (`    int T_prime = rows(y_prime_bar);`): Records number of time points in the second dataset summary.
- Line 23 (`    vector[T_prime] M_tilde;`): Allocates a vector for simulated means at each time point.
- Line 24 (`    matrix[T_prime,T_prime] Sigma_tilde;`): Allocates covariance for simulated means.
- Line 25 (`    vector[K] mu_a_tilde;`): Placeholder for shifted means.
- Line 26 (`    matrix[K,J_tilde] a_tilde;`): Matrix to hold simulated random-effect draws per subject.
- Line 27 (`    matrix[T_prime,J_tilde] y_tilde;`): Matrix for simulated responses across time and subjects.
- Line 28 (``): Blank line aiding readability.
- Line 29 (`    mu_a_tilde = mu_a + delta;`): Shifts baseline by treatment effect to get mean under prime condition.
- Line 30 (``): Blank line aiding readability.
- Line 31 (`    a_tilde = rep_matrix(mu_a_tilde, J_tilde) + diag_pre_multiply(sigma_a, xi);`): Builds simulated random effects by scaling standard normals and adding the mean.
- Line 32 (``): Blank line aiding readability.
- Line 33 (`    for (k in 1:T_prime) {`): Starts loop over time points for simulation.
- Line 34 (`      y_tilde[k] = a_tilde[1] + a_tilde[2]*x_prime[k] + beta*x_prime[k]^2;`): Generates simulated responses using quadratic model for each subject at time `k`.
- Line 35 (`      M_tilde[k] = mean(y_tilde[k]);`): Stores average simulated response across subjects at time `k`.
- Line 36 (`    }`): Ends loop over time points.
- Line 37 (`    // simulated cov matrix + residual error term`): Comment introducing covariance calculation.
- Line 38 (`    Sigma_tilde = robust_cov(y_tilde', to_row_vector(M_tilde)) +`): Computes covariance of simulated means via `robust_cov`.
- Line 39 (`      diag_matrix(rep_vector( square(sigma_y), T_prime));`): Adds diagonal residual variance scaled by number of time points.
- Line 40 (``): Blank line aiding readability.
- Line 41 (`    return multi_normal_lpdf(y_prime_bar| M_tilde, Sigma_tilde/J_prime);`): Returns log-density of observed averages given simulated mean and scaled covariance.
- Line 42 (`  }`): Closes `mvn_approx_lpdf`.
- Line 43 (``): Blank line separating functions.
- Line 44 (`  vector colMeans(matrix y) {`): Declares helper to compute column means.
- Line 45 (`    vector[cols(y)] m;`): Allocates result vector sized by columns of `y`.
- Line 46 (`    for (i in 1:cols(y))`): Begins loop over columns.
- Line 47 (`      m[i] = mean(col(y, i));`): Assigns average of each column to output.
- Line 48 (`    return(m);`): Returns the column means.
- Line 49 (`  }`): Closes `colMeans`.
- Line 50 (``): Blank line finishing functions block content.
- Line 51 (`}`): Ends the Stan `functions` block.
- Line 52 (`data {`): Opens the `data` block for inputs provided at sampling time.
- Line 53 (`  int<lower=-1,upper=1> fit_all;`): Controls inclusion of additional datasets using bounded integer flag.
- Line 54 (`  int<lower= 0,upper=1> fit_local;`): Flag to decide whether to fit only local data.
- Line 55 (`  int J;                         // #people in y`): Number of subjects in main dataset with comment.
- Line 56 (`  int T;                         // #time points in y`): Number of observations per subject in main dataset.
- Line 57 (`  int K;                         // #parameters in delta`): Dimension of random effects and delta.
- Line 58 (`  int K_phi;                     // #parameters in phi`): Size of `phi` parameter vector for priors.
- Line 59 (`  matrix[J,T] y;`): Observed outcomes for main dataset.
- Line 60 (`  int J_prime;                   // #people in second dataset`): Subjects in secondary dataset.
- Line 61 (`  int T_prime;                   // #time points in second dataset`): Time points in secondary dataset.
- Line 62 (`  matrix[J_prime,T_prime] y_prime;`): Observed outcomes for secondary dataset.
- Line 63 (`  vector[T] x;`): Covariate values for main dataset across time.
- Line 64 (`  vector[T_prime] x_prime;`): Covariate values for secondary dataset.
- Line 65 (`  vector[K_phi] mu_phi_p;        // prior mean`): Prior mean vector for `phi`.
- Line 66 (`  cov_matrix[K_phi] Sigma_phi_p; // prior variance`): Prior covariance for `phi`.
- Line 67 (`  vector[K] mu_delta_p;          // prior mean`): Prior mean for treatment effect shift `delta`.
- Line 68 (`  cov_matrix[K] Sigma_delta_p;   // prior variance`): Prior covariance for `delta`.
- Line 69 (`  int J_tilde;                   // number of fake patients used for approximate log-lik`): Number of Monte Carlo draws for approximation.
- Line 70 (`  int C;`): Total number of chains using shared random seeds.
- Line 71 (`  int<lower=1, upper=C> CHAIN_ID;`): Identifier for current chain.
- Line 72 (`  matrix[K, 2*J_tilde] xi[C];         // N(0,1) random numbers used for integration`): Pre-generated standard normal draws per chain.
- Line 73 (`}`): Closes the `data` block.
- Line 74 (`transformed data {`): Opens block to precompute shared quantities.
- Line 75 (`  vector[T_prime] ones         = rep_vector(1, T_prime);`): Creates vector of ones for intercept handling.
- Line 76 (`  matrix[T_prime,K] X_prime    = append_col(ones, x_prime);`): Builds design matrix combining intercept and covariate.
- Line 77 (`  cov_matrix[T_prime] identity = diag_matrix(ones);`): Stores identity matrix matching time dimension.
- Line 78 (`  int K_phi_mean = K_phi - 3;`): Calculates portion of `phi` governed by multivariate prior on means.
- Line 79 (`  cholesky_factor_cov[K_phi_mean] L_Sigma_phi_p   = cholesky_decompose(Sigma_phi_p[1:K_phi_mean,1:K_phi_mean]);`): Precomputes Cholesky factor for truncated prior covariance on means.
- Line 80 (`  cholesky_factor_cov[K]          L_Sigma_delta_p = cholesky_decompose(Sigma_delta_p);`): Cholesky factor for `delta` prior covariance.
- Line 81 (`  int J_tilde_chain = (CHAIN_ID % 2 == 0) ? 2*J_tilde : J_tilde;`): Doubles simulation draws on even-numbered chains for variance reduction.
- Line 82 (`  matrix[K, J_tilde_chain] xi_tilde = xi[CHAIN_ID, 1:K, 1:J_tilde_chain];`): Selects the precomputed random draws for current chain and dimension.
- Line 83 (`  vector[T_prime] y_prime_bar = colMeans(y_prime);`): Computes column means of secondary dataset.
- Line 84 (``): Blank line for readability.
- Line 85 (`  print("Running chain ", CHAIN_ID, " with J_tilde_chain = ", J_tilde_chain, "...");`): Emits message to console to trace chain configuration.
- Line 86 (`}`): Closes `transformed data` block.
- Line 87 (`parameters {`): Opens model parameter declarations.
- Line 88 (`  matrix[K,J] eta_a;`): Non-centered random effects for primary dataset.
- Line 89 (`  real<lower=0> sigma_y;`): Residual standard deviation constrained positive.
- Line 90 (`  vector[K] mu_a;`): Population-level means for random effects.
- Line 91 (`  vector<lower=0>[K] sigma_a;    // Now assuming indep`): Standard deviations of random effects with non-negativity constraint.
- Line 92 (`  real beta;                     // Shared parameter`): Quadratic term shared across datasets.
- Line 93 (`  vector[K] delta;`): Treatment effect offsets for secondary dataset.
- Line 94 (`  matrix[K,J_prime] eta_prime_a;`): Non-centered random effects for secondary dataset.
- Line 95 (`}`): Closes `parameters` block.
- Line 96 (`transformed parameters {`): Opens block to define deterministic transformations.
- Line 97 (`  matrix[K,J] a;`): Holder for realized random effects for main dataset.
- Line 98 (`  matrix[K,J_prime] a_prime;`): Holder for realized random effects for secondary dataset.
- Line 99 (`  vector[K_phi] phi;`): Vector aggregating parameters for prior application.
- Line 100 (`  real y_log;`): Storage for log-likelihood contribution of primary data.
- Line 101 (`  real y_prime_log;`): Storage for log-likelihood contribution of secondary data.
- Line 102 (`  `): Blank line (contains spaces) for readability.
- Line 103 (`  a = rep_matrix(mu_a, J) + diag_pre_multiply(sigma_a, eta_a);`): Realizes primary random effects via non-centered parameterization.
- Line 104 (`  a_prime = rep_matrix(mu_a + delta, J_prime) + diag_pre_multiply(sigma_a, eta_prime_a);`): Realizes secondary random effects shifted by `delta`.
- Line 105 (`  `): Blank line (contains spaces) for readability.
- Line 106 (`  phi[1] = mu_a[1];`): Stores first mean component into `phi`.
- Line 107 (`  phi[2] = mu_a[2];`): Stores second mean component into `phi`.
- Line 108 (`  phi[3] = beta;`): Moves quadratic coefficient into `phi`.
- Line 109 (`  phi[4] = log(sigma_a[1]);`): Transforms first random-effect scale to log-scale for prior consistency.
- Line 110 (`  phi[5] = log(sigma_a[2]);`): Transforms second random-effect scale.
- Line 111 (`  phi[6] = log(sigma_y);`): Places log residual scale into `phi`.
- Line 112 (``): Blank line for readability.
- Line 113 (`  {`): Opens scoped block to avoid leaking temporary variables.
- Line 114 (`    matrix[J,T] y_pred;`): Allocates space for predicted main dataset responses.
- Line 115 (`    for (j in 1:J)`): Begins loop across subjects in main dataset.
- Line 116 (`      for (k in 1:T)`): Nested loop across time points.
- Line 117 (`        y_pred[j,k] = a[1,j] + a[2,j]*x[k] + beta*x[k]^2;`): Fills prediction matrix using quadratic model.
- Line 118 (`  `): Blank line with spaces for readability inside block.
- Line 119 (`    y_log = normal_lpdf(to_vector(y)| to_vector(y_pred), sigma_y);`): Computes log-likelihood of observed main data under Gaussian noise.
- Line 120 (`  }`): Closes scoped block for main dataset likelihood.
- Line 121 (``): Blank line separating likelihood components.
- Line 122 (`  if (!fit_local) {`): Checks whether to include secondary dataset information.
- Line 123 (`    if (fit_all == 1) {`): Branch for fully using secondary raw data.
- Line 124 (`      // include raw data from prime data set`): Comment describing branch.
- Line 125 (`      matrix[J_prime,T_prime] y_prime_pred;`): Allocates predictions for secondary dataset.
- Line 126 (`      for (j in 1:J_prime)`): Loop over secondary subjects.
- Line 127 (`        for (k in 1:T_prime)`): Loop over secondary time points.
- Line 128 (`          y_prime_pred[j,k] = a_prime[1,j] + a_prime[2,j]*x_prime[k] + beta*x_prime[k]^2;`): Predicts secondary outcomes using shifted random effects.
- Line 129 (`      `): Blank line with spaces in branch for readability.
- Line 130 (`      y_prime_log = normal_lpdf(to_vector(y_prime)| to_vector(y_prime_pred), sigma_y);`): Computes Gaussian log-likelihood for secondary raw data.
- Line 131 (`    } else if (fit_all == -1) {`): Branch for analytic integration of secondary data.
- Line 132 (`      // integrated approach`): Comment for branch.
- Line 133 (`      vector[T_prime] y_prime_pred_bar;`): Vector for expected secondary means.
- Line 134 (`      matrix[T_prime,T_prime] Sigma_y_prime_bar;`): Covariance matrix for mean estimates.
- Line 135 (`      Sigma_y_prime_bar = (X_prime*diag_matrix(sigma_a .* sigma_a)*X_prime' + sigma_y^2*identity)/J_prime;`): Computes theoretical covariance of averaged responses under random effects and noise.
- Line 136 (`      for (k in 1:T_prime)`): Loop across time points to compute expected means.
- Line 137 (`        y_prime_pred_bar[k] = mu_a[1] + delta[1] + (mu_a[2] + delta[2])*x_prime[k] + beta*x_prime[k]^2;`): Sets expected mean trajectory given shifts.
- Line 138 (`      `): Blank line with spaces for readability.
- Line 139 (`       y_prime_log = multi_normal_lpdf(y_prime_bar| y_prime_pred_bar, Sigma_y_prime_bar);`): Evaluates multivariate normal log-likelihood for observed means.
- Line 140 (`    } else {`): Fallback branch for approximate treatment.
- Line 141 (`      // approximate approach`): Comment for branch.
- Line 142 (`      y_prime_log = mvn_approx_lpdf(y_prime_bar| x_prime, J_prime, delta, mu_a, beta, sigma_a, sigma_y, xi_tilde);`): Calls helper to approximate log-likelihood via simulation.
- Line 143 (`    }`): Closes inner conditional.
- Line 144 (`  } else {`): Branch when only local data should be used.
- Line 145 (`    y_prime_log = 0;`): Sets secondary contribution to zero.
- Line 146 (`  }`): Closes outer conditional.
- Line 147 (`}`): Closes `transformed parameters` block.
- Line 148 (`model {`): Opens `model` block for priors and target increments.
- Line 149 (`  target += y_log;`): Adds main dataset likelihood to posterior target.
- Line 150 (`  target += y_prime_log;`): Adds secondary dataset contribution (if any).
- Line 151 (``): Blank line for readability.
- Line 152 (`  target += normal_lpdf(to_vector(eta_a)|       0, 1);`): Places standard normal priors on non-centered random effects for main data.
- Line 153 (`  target += normal_lpdf(to_vector(eta_prime_a)| 0, 1);`): Places standard normal priors on non-centered random effects for secondary data.
- Line 154 (``): Blank line before prior definitions.
- Line 155 (`  // assign prior to all means`): Comment for subsequent priors.
- Line 156 (`  target += multi_normal_cholesky_lpdf(phi[1:K_phi_mean]| mu_phi_p[1:K_phi_mean], L_Sigma_phi_p  );`): Applies multivariate normal prior to mean-related elements with Cholesky factorization.
- Line 157 (`  target += multi_normal_cholesky_lpdf(delta|             mu_delta_p,             L_Sigma_delta_p);`): Applies multivariate normal prior to delta using Cholesky factor.
- Line 158 (``): Blank line before variance priors.
- Line 159 (`  // assign priors to variance components on the natural scale, always`): Comment describing variance priors.
- Line 160 (`  // assume these uncorrelated`): Comment highlighting independence assumption.
- Line 161 (`  target += normal_lpdf(sigma_a[1]| 0, sqrt(Sigma_phi_p[K_phi_mean+1,K_phi_mean+1]));`): Sets normal prior on first random-effect scale using prior variance entry.
- Line 162 (`  target += normal_lpdf(sigma_a[2]| 0, sqrt(Sigma_phi_p[K_phi_mean+2,K_phi_mean+2]));`): Sets normal prior on second random-effect scale.
- Line 163 (`  target += normal_lpdf(sigma_y   | 0, sqrt(Sigma_phi_p[K_phi_mean+3,K_phi_mean+3]));`): Sets normal prior on residual standard deviation.
- Line 164 (`}`): Closes the `model` block and completes the Stan program.
